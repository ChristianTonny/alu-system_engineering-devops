#!/usr/bin/env bash
# Configure Nginx to run as nginx user and listen on port 8080

# Make sure nginx user exists
id -u nginx &>/dev/null || useradd -r nginx

# Set proper permissions for nginx directories
chown -R nginx:nginx /var/log/nginx
chown -R nginx:nginx /etc/nginx/conf.d
chown -R nginx:nginx /var/lib/nginx

# Modify the Nginx config to listen on port 8080 instead of 80
sed -i 's/listen 80 default_server;/listen 8080 default_server;/g' /etc/nginx/sites-available/default
sed -i 's/listen \[::\]:80 default_server;/listen \[::\]:8080 default_server;/g' /etc/nginx/sites-available/default

# If there's an nginx.conf file, update it too
if [ -f /etc/nginx/nginx.conf ]; then
    # Set user to nginx in nginx.conf
    sed -i 's/user www-data;/user nginx;/g' /etc/nginx/nginx.conf
    # Update any port 80 references to 8080
    sed -i 's/listen 80;/listen 8080;/g' /etc/nginx/nginx.conf
fi

# Make sure nginx can bind to port 8080
setcap 'cap_net_bind_service=+ep' /usr/sbin/nginx

# Stop Nginx if it's running
service nginx stop || true

# Start Nginx as the nginx user
su -s /bin/bash -c "service nginx start" nginx 